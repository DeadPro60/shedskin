<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
<title>Shed Skin Tutorial</title>
<meta name="date" content="July 15, 2009" />
<meta name="authors" content="Mark Dufour and James Coughlan" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5196 2007-06-03 20:25:28Z wiemann $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="shed-skin-tutorial">
<h1 class="title">Shed Skin Tutorial</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Version:</th>
<td>Shed Skin 0.2</td></tr>
<tr><th class="docinfo-name">Date:</th>
<td>July 15, 2009</td></tr>
<tr><th class="docinfo-name">Authors:</th>
<td>Mark Dufour and James Coughlan</td></tr>
</tbody>
</table>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id13">Introduction</a></li>
<li><a class="reference internal" href="#id2" id="id14">Typing Restrictions</a></li>
<li><a class="reference internal" href="#id3" id="id15">Python Subset Restrictions</a></li>
<li><a class="reference internal" href="#id4" id="id16">Library Limitations</a></li>
<li><a class="reference internal" href="#id5" id="id17">Installation</a></li>
<li><a class="reference internal" href="#id6" id="id18">Compiling and Running a Stand-Alone Program</a></li>
<li><a class="reference internal" href="#id7" id="id19">Compiling an Extension Module</a></li>
<li><a class="reference internal" href="#id8" id="id20">Parallel Processing</a></li>
<li><a class="reference internal" href="#id9" id="id21">Calling C/C++ Code</a></li>
<li><a class="reference internal" href="#id10" id="id22">Command-line Options</a></li>
<li><a class="reference internal" href="#id11" id="id23">Tips and Tricks</a></li>
<li><a class="reference internal" href="#id12" id="id24">How to help out in Shed Skin Development</a></li>
<li><a class="reference internal" href="#shed-skin-roadmap" id="id25">Shed Skin Roadmap</a></li>
</ul>
</div>
<div class="section" id="id1">
<span id="introduction"></span><h1><a class="toc-backref" href="#id13">Introduction</a></h1>
<p><strong>Shed Skin</strong> is an <em>experimental</em> <strong>Python-to-C++ compiler</strong> designed to speed up the execution of computation-intensive Python programs. It converts programs written in a <em>static subset</em> of Python to C++. The C++ code can be compiled to executable code, which can be run either as a standalone program or as an extension module easily imported and used in a regular Python program.</p>
<p><strong>Shed Skin</strong> uses type inference techniques to determine the <em>implicit</em> types used in a Python program, in order to generate the <em>explicit</em> type declarations needed in a C++ version. Because C++ is <em>statically typed</em>, <strong>Shed Skin</strong> requires Python code to be written such that all variables are (implicitly) statically typed.</p>
<p>Besides the <em>typing</em> and <em>subset</em> restrictions, supported programs cannot freely use the Python standard library, although the most common modules are supported, such as <tt class="docutils literal"><span class="pre">random</span></tt> and <tt class="docutils literal"><span class="pre">re</span></tt> (see <a class="reference internal" href="#library-limitations">Library Limitations</a>).</p>
<p>Additionally, the type inference techniques employed by <strong>Shed Skin</strong> currently do not scale very well beyond several hundred lines of code (the largest compiled program is about 1,600 lines). In all, this means that <strong>Shed Skin</strong> is currently mostly useful to compile <em>smallish</em> programs and extension modules, that do not make extensive use of dynamic Python features or the standard library.</p>
<p>Because <strong>Shed Skin</strong> is still in an early stage of development, it can also improve a lot. At the moment, you will probably run into some bugs when using it. Please report these, so they can be fixed!</p>
<p>At the moment, <strong>Shed Skin</strong> is only compatible with Python versions 2.4 to 2.6, and should work on GNU/Linux platforms, FreeBSD, OpenSolaris, OSX and Windows XP.</p>
</div>
<div class="section" id="id2">
<span id="typing-restrictions"></span><h1><a class="toc-backref" href="#id14">Typing Restrictions</a></h1>
<p><strong>Shed Skin</strong> translates pure, but <em>implicitly statically typed</em>, Python programs into C++. The static typing restriction means that variables can only ever have a <em>single, static type</em>. So, for example,</p>
<pre class="literal-block">
a = 1
a = ’1’ # bad
</pre>
<p>is not allowed. However, as in C++, types can be <em>abstract</em>, so that, for example,</p>
<pre class="literal-block">
a = A()
a = B() # good
</pre>
<p>where <strong>A</strong> and <strong>B</strong> have a common base class, is allowed.</p>
<p>The typing restriction also means that the elements of some collection (<tt class="docutils literal"><span class="pre">list</span></tt>, <tt class="docutils literal"><span class="pre">set</span></tt>, etc.) cannot have different types (because their <em>subtype</em> must also be static). Thus:</p>
<pre class="literal-block">
a = [’apple’, ’b’, ’c’] # good
b = (1, 2, 3) # good
c = [[10.3, -2.0], [1.5, 2.3], []] # good
</pre>
<p>are allowed, but</p>
<pre class="literal-block">
d = [1, 2.5, ’abc’] # bad
e = [3, [1, 2]] # bad
f = (0, ’abc’, [1, 2, 3]) # bad
</pre>
<p>are not allowed. Of course, dictionary keys and values may be of different types:</p>
<pre class="literal-block">
g = {’a’: 1, ’b’: 2, ’c’: 3} # good
h = {’a’: 1, ’b’: ’hello’, ’c’: [1, 2, 3]} # bad
</pre>
<p>In the current version of <strong>Shed Skin</strong>, mixed types are also permitted in tuples of length two:</p>
<pre class="literal-block">
a = (1, [1]) # good
</pre>
<p>In the future, mixed tuples up to a certain length will be allowed.</p>
<p><tt class="docutils literal"><span class="pre">None</span></tt> may only be mixed with non-scalar types (i.e., not with <tt class="docutils literal"><span class="pre">int</span></tt> or <tt class="docutils literal"><span class="pre">float</span></tt>):</p>
<pre class="literal-block">
l = [1]
l = None # good

m = 1
m = None # bad

def fun(x = None): # bad: use a special value for x here, e.g. x = -1
    pass
fun(1)
</pre>
<p>Integers and floats can often be mixed, but it is better to avoid this where possible, as it may confuse <strong>Shed Skin</strong>:</p>
<pre class="literal-block">
a = [1.0]
a = [1] # wrong - use a float here, too
</pre>
</div>
<div class="section" id="id3">
<span id="python-subset-restrictions"></span><h1><a class="toc-backref" href="#id15">Python Subset Restrictions</a></h1>
<p><strong>Shed Skin</strong> will only ever support a subset of all Python features. The following common features are currently not supported:</p>
<blockquote>
<ul class="simple">
<li>reflection (getattr, hasattr), eval, or other really dynamic stuff</li>
<li>arbitrary-size arithmetic (integers become 32-bit on most architectures!)</li>
<li>generator expressions</li>
<li>variable numbers of arguments and keyword arguments</li>
<li>multiple inheritance</li>
<li>nested functions and classes</li>
<li>inheritance from builtins (excluding Exception and object)</li>
<li>some builtins, such as <tt class="docutils literal"><span class="pre">map</span></tt>, <tt class="docutils literal"><span class="pre">filter</span></tt> and <tt class="docutils literal"><span class="pre">reduce</span></tt></li>
<li>overloading <tt class="docutils literal"><span class="pre">__iter__</span></tt> and <tt class="docutils literal"><span class="pre">__call__</span></tt></li>
</ul>
</blockquote>
<p>Some other features are currently only partially supported:</p>
<blockquote>
<ul>
<li><p class="first">class attributes must always be accessed using a class identifier:</p>
<pre class="literal-block">
self.class_attr # bad
SomeClass.class_attr # good
</pre>
</li>
<li><p class="first">anonymous function passing works reasonably well, but not for methods, and they cannot be contained:</p>
<pre class="literal-block">
var = lambda x, y: x+y # good
var = some_func # good
var = self.some_method # bad
[var] # bad
</pre>
</li>
</ul>
</blockquote>
</div>
<div class="section" id="id4">
<span id="library-limitations"></span><h1><a class="toc-backref" href="#id16">Library Limitations</a></h1>
<p>Programs to be compiled with <strong>Shed Skin</strong> cannot freely use the Python standard library. Only about 17 common modules are currently supported.</p>
<p>Note that <strong>Shed Skin</strong> can be used to build an extension module, so the main program can use arbitrary modules (and of course all Python features!). See <a class="reference internal" href="#compiling-an-extension-module">Compiling an Extension Module</a>.</p>
<p>In general, programs can only import functionality that is defined in the <strong>Shed Skin</strong> <tt class="docutils literal"><span class="pre">lib/</span></tt> directory. The following modules are largely supported at the moment:</p>
<blockquote>
<ul class="simple">
<li>bisect</li>
<li>collections</li>
<li>ConfigParser</li>
<li>copy</li>
<li>datetime</li>
<li>fnmatch</li>
<li>getopt</li>
<li>glob</li>
<li>math</li>
<li>os (some functionality missing under Windows)</li>
<li>os.path</li>
<li>random</li>
<li>re</li>
<li>socket</li>
<li>string</li>
<li>sys</li>
<li>time</li>
</ul>
</blockquote>
<p>See <a class="reference internal" href="#how-to-help-out-in-shed-skin-development">How to help out in Shed Skin Development</a> on how to help improve or add to these modules.</p>
</div>
<div class="section" id="id5">
<span id="installation"></span><h1><a class="toc-backref" href="#id17">Installation</a></h1>
<p>The latest version of <strong>Shed Skin</strong> can be downloaded from the <a class="reference external" href="http://shedskin.googlecode.com/">Googlecode site</a>. There are three types of packages available: a self-extracting <strong>Windows</strong> installer, a <strong>Debian</strong> (<strong>Ubuntu</strong>) package, and a <strong>UNIX</strong> source package.</p>
<p><strong>Windows</strong></p>
<p>To install the <strong>Windows</strong> version, simply download and start it. (If you use <strong>ActivePython</strong> or some other non-standard Python distribution, or <strong>MingW</strong>, please deinstall this first.)</p>
<p><strong>Debian</strong> (<strong>Ubuntu</strong>)</p>
<p>To install the <strong>Debian</strong> package, simply download and install it using your package manager.</p>
<p>If there are complaints about missing dependencies, the following explicitly installs these:</p>
<p><tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">g++</span> <span class="pre">libpcre3-dev</span> <span class="pre">libgc-dev</span></tt></p>
<p><strong>GNU/Linux</strong></p>
<p>To install the <strong>UNIX</strong> source package on a <strong>GNU/Linux</strong> system, take the following steps:</p>
<blockquote>
<ul class="simple">
<li>download and unpack it</li>
<li>run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span></tt> and place the generated <tt class="docutils literal"><span class="pre">shedskin</span></tt> file in your path</li>
<li>make sure you can run <tt class="docutils literal"><span class="pre">g++</span></tt>, the C++ compiler</li>
<li>install the <a class="reference external" href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/">Boehm</a> garbage collector</li>
<li>install the <a class="reference external" href="http://www.pcre.org/">PCRE</a> library</li>
</ul>
</blockquote>
<p>on a <strong>Fedora</strong> system, the last three steps are simply:</p>
<p><tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">yum</span> <span class="pre">install</span> <span class="pre">gcc-c++</span> <span class="pre">pcre-devel</span> <span class="pre">gc-devel</span></tt></p>
<p><strong>FreeBSD</strong></p>
<p>To install the <strong>UNIX</strong> source package on a <strong>FreeBSD</strong> system, take the following steps:</p>
<blockquote>
<ul>
<li><p class="first">download and unpack it</p>
</li>
<li><p class="first">run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span></tt> and place the generated <tt class="docutils literal"><span class="pre">shedskin</span></tt> file in your path</p>
</li>
<li><p class="first">install the <a class="reference external" href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/">Boehm</a> garbage collector, making sure to disable threading support:</p>
<p><tt class="docutils literal"><span class="pre">./configure</span> <span class="pre">--enable-cplusplus</span> <span class="pre">--disable-threads</span> <span class="pre">--prefix=/usr</span> <span class="pre">&amp;&amp;</span> <span class="pre">make</span> <span class="pre">install</span></tt></p>
</li>
<li><p class="first">install the <a class="reference external" href="http://www.pcre.org/">PCRE</a> library</p>
</li>
</ul>
</blockquote>
<p><strong>OpenSolaris</strong></p>
<p>To install the <strong>UNIX</strong> source package on an <strong>OpenSolaris</strong> system, take the following steps:</p>
<blockquote>
<ul>
<li><p class="first">download and unpack it</p>
</li>
<li><p class="first">run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span></tt> and place the generated <tt class="docutils literal"><span class="pre">shedskin</span></tt> file in your path</p>
</li>
<li><p class="first">install the following packages:</p>
<pre class="literal-block">
SUNWgcc
SUNWhea
SUNWarc
SUNWlibgc
SUNWpcre
</pre>
</li>
</ul>
</blockquote>
<p><strong>OSX</strong></p>
<p>To install the <strong>UNIX</strong> source package on an <strong>OSX</strong> system, take the following steps:</p>
<blockquote>
<ul class="simple">
<li>download and unpack it</li>
<li>run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span></tt> and place the generated <tt class="docutils literal"><span class="pre">shedskin</span></tt> file in your path</li>
<li>install the Apple XCode development environment</li>
<li>install the <a class="reference external" href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/">Boehm</a> garbage collector</li>
<li>install the <a class="reference external" href="http://www.pcre.org/">PCRE</a> library</li>
</ul>
</blockquote>
</div>
<div class="section" id="id6">
<span id="compiling-and-running-a-stand-alone-program"></span><h1><a class="toc-backref" href="#id18">Compiling and Running a Stand-Alone Program</a></h1>
<p>To use <strong>Shed Skin</strong> under Windows, first execute (double-click) the <tt class="docutils literal"><span class="pre">init.bat</span></tt> file in the <tt class="docutils literal"><span class="pre">shedskin-0.1</span></tt> directory, relative to where you installed it.  A command-line window will appear, with the current directory set to the <tt class="docutils literal"><span class="pre">shedskin-0.1\shedskin</span></tt> directory (hereafter referred to as the <em>Shed Skin working directory</em>).</p>
<p>Consider the following simple test program, called <tt class="docutils literal"><span class="pre">test.py</span></tt>:</p>
<pre class="literal-block">
# test.py

print 'hello, world!'
</pre>
<p>To compile this program to C++, type:</p>
<pre class="literal-block">
shedskin test
</pre>
<p>This will create two C++ files, called <tt class="docutils literal"><span class="pre">test.cpp</span></tt> and <tt class="docutils literal"><span class="pre">test.hpp</span></tt>, as well as a type-annotated file called <tt class="docutils literal"><span class="pre">test.ss.py</span></tt>.</p>
<p>To create and run an executable file (called <tt class="docutils literal"><span class="pre">test.exe</span></tt> under Windows or otherwise <tt class="docutils literal"><span class="pre">test</span></tt>), type:</p>
<pre class="literal-block">
make run
</pre>
<p>The following output should now appear on the command line:</p>
<pre class="literal-block">
hello, world!
</pre>
<p>To only build, but not run the executable file, omit the <tt class="docutils literal"><span class="pre">run</span></tt> part:</p>
<pre class="literal-block">
make
</pre>
<p>For the executable file to execute properly under Windows, note that <tt class="docutils literal"><span class="pre">gc.dll</span></tt> and <tt class="docutils literal"><span class="pre">libpcre-0.dll</span></tt> (located in the <strong>Shed Skin</strong> working directory) must be located somewhere in the Windows path. This happens automatically when running <tt class="docutils literal"><span class="pre">init.bat</span></tt>.</p>
</div>
<div class="section" id="id7">
<span id="compiling-an-extension-module"></span><h1><a class="toc-backref" href="#id19">Compiling an Extension Module</a></h1>
<p>Extension modules are compiled binaries, typically written in C or C++ for speed, that can be imported and used like regular Python modules. They allow one to write most of a project in unrestricted Python, while optimizing one or more speed-critical parts.</p>
<p>It is very easy to generate extension modules with <strong>Shed Skin</strong>.</p>
<p><strong>Simple Example</strong></p>
<p>We begin with a simple example module, called <tt class="docutils literal"><span class="pre">simple_module.py</span></tt>, containing two simple functions:</p>
<pre class="literal-block">
# simple_module.py

def func1(x):
    return x+1

def func2(n):
    d = dict([(i, i*i)  for i in range(n)])
    return d

if __name__ == '__main__':
    print func1(5)
    print func2(10)
</pre>
<p>In order for type inference to work, the module must (<em>indirectly</em>) call its own functions (if <tt class="docutils literal"><span class="pre">func1</span></tt> calls <tt class="docutils literal"><span class="pre">func2</span></tt>, we can omit the call to <tt class="docutils literal"><span class="pre">func2</span></tt>). This is accomplished in the example by putting the function calls under the <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__=='__main__'</span></tt> statement, so that they will not be executed when the module is imported.</p>
<p>To compile the module into an extension module, type:</p>
<pre class="literal-block">
shedskin -e simple_module
make
</pre>
<p>On <strong>UNIX</strong> systems, for 'make' to succeed, you must have the Python development files installed (under <strong>Debian</strong>, install <tt class="docutils literal"><span class="pre">python-dev</span></tt>; under <strong>Fedora</strong>, install <tt class="docutils literal"><span class="pre">python-devel</span></tt>).</p>
<p>Depending on platform, the resulting extension module (<em>shared library</em>) is called <tt class="docutils literal"><span class="pre">simple_module.so</span></tt> or <tt class="docutils literal"><span class="pre">simple_module.pyd</span></tt>.</p>
<p>The extension module can now be simply imported as usual:</p>
<pre class="literal-block">
&gt;&gt;&gt; from simple_module import func1, func2
&gt;&gt;&gt; func1(5)
6
&gt;&gt;&gt; func2(10)
{0: 0, 1: 1, 2: 4, 3: 9, 4: 16, 5: 25, 6: 36, 7: 49, 8: 64, 9: 81}
</pre>
<p>Note that calling <tt class="docutils literal"><span class="pre">func1</span></tt> with a non-integer argument causes an error:</p>
<pre class="literal-block">
&gt;&gt;&gt; func1(10.5)
Traceback (most recent call last):
  File &quot;&lt;pyshell#0&gt;&quot;, line 1, in -toplevel-
    func1(10.5)
TypeError: error in conversion to Shed Skin (integer expected)
</pre>
<p>It is useful to know which version of the module you are importing: either the <strong>Shed Skin</strong> version (<tt class="docutils literal"><span class="pre">simple_module.so</span></tt> or <tt class="docutils literal"><span class="pre">simple_module.pyd</span></tt>) or the original Python version (<tt class="docutils literal"><span class="pre">simple_module.py</span></tt> or <tt class="docutils literal"><span class="pre">simple_module.pyc</span></tt>). One way to determine this, is to include the following code in the top of the module:</p>
<pre class="literal-block">
import sys
print sys.version
</pre>
<p><strong>Restrictions</strong></p>
<p>There are several important restrictions that must be observed when compiling an extension module:</p>
<ol class="arabic simple">
<li>Only builtin scalar and container types (<tt class="docutils literal"><span class="pre">int</span></tt>, <tt class="docutils literal"><span class="pre">float</span></tt>, <tt class="docutils literal"><span class="pre">complex</span></tt>, <tt class="docutils literal"><span class="pre">str</span></tt>, <tt class="docutils literal"><span class="pre">list</span></tt>, <tt class="docutils literal"><span class="pre">tuple</span></tt>, <tt class="docutils literal"><span class="pre">dict</span></tt>, <tt class="docutils literal"><span class="pre">set</span></tt>, <tt class="docutils literal"><span class="pre">frozenset</span></tt>) as well as <tt class="docutils literal"><span class="pre">None</span></tt> and instances of user-defined classes can be passed/returned. So for instance, anonymous functions and iterators are currently not supported.</li>
<li>Builtin objects are completely converted for each call/return from <strong>Shed Skin</strong> to <strong>CPython</strong> types and back, including their contents. This means you cannot change <strong>CPython</strong> builtin objects from the <strong>Shed Skin</strong> side and vice versa, and conversion may be slow. Instances of user-defined classes can be passed/returned without any conversion, and changed from either side.</li>
<li>Global variables are converted once, at initialization time, from <strong>Shed Skin</strong> to <strong>CPython</strong>. This means that the value of the <strong>CPython</strong> version and <strong>Shed Skin</strong> version can change independently. This problem can be avoided by only using constant globals, or by adding getter/setter functions.</li>
<li>Keyword arguments are not supported at the moment.</li>
</ol>
<p><strong>Example for NumPy/SciPy users</strong></p>
<p>The following example demonstrates how a matrix created in <a class="reference external" href="http://numpy.scipy.org/">NumPy</a> can be processed by an extension module generated with <strong>Shed Skin</strong>. The function <tt class="docutils literal"><span class="pre">my_sum</span></tt> sums all the elements in a matrix:</p>
<pre class="literal-block">
# simple_module2.py

def my_sum(a):
    &quot;&quot;&quot; compute sum of elements in list of lists (matrix) &quot;&quot;&quot;
    h = len(a) # number of rows in matrix
    w = len(a[0]) # number of columns
    s = 0.0
    for i in range(h):
        for j in range(w):
            s += a[i][j]
    return s

if __name__ == '__main__':
    print my_sum([[1.0, 2.0], [3.0, 4.0]])
</pre>
<p>(This example is given purely as an illustration, since <a class="reference external" href="http://numpy.scipy.org/">NumPy</a> arrays already include a built-in <tt class="docutils literal"><span class="pre">sum</span></tt> method.)</p>
<p>After compiling the module with <strong>Shed Skin</strong>, the <tt class="docutils literal"><span class="pre">my_sum</span></tt> function can now be used as follows:</p>
<pre class="literal-block">
&gt;&gt;&gt; import numpy
&gt;&gt;&gt; from simple_module2 import my_sum
&gt;&gt;&gt; a = numpy.array(([1.0, 2.0], [3.0, 4.0]))
&gt;&gt;&gt; my_sum(a.tolist())
10.0
</pre>
<p>The <tt class="docutils literal"><span class="pre">tolist</span></tt> call is necessary here, as <strong>Shed Skin</strong> does not directly support <a class="reference external" href="http://numpy.scipy.org/">NumPy</a> types.</p>
</div>
<div class="section" id="id8">
<span id="parallel-processing"></span><h1><a class="toc-backref" href="#id20">Parallel Processing</a></h1>
<p>Extension modules generated by <strong>Shed Skin</strong> can be easily combined with parallel processing software such as <a class="reference external" href="http://www.parallelpython.com/">Parallel Python</a> and <a class="reference external" href="http://www.boddie.org.uk/python/pprocess.html">pprocess</a>.</p>
<p>Suppose we have defined the following function in a file, called <tt class="docutils literal"><span class="pre">meuk.py</span></tt>:</p>
<pre class="literal-block">
# meuk.py

def part_sum(start, end):
    &quot;&quot;&quot; calculate partial sum &quot;&quot;&quot;
    sum = 0
    for x in xrange(start, end):
        if x % 2 == 0:
            sum -= 1.0 / x
        else:
            sum += 1.0 / x
    return sum

if __name__ == ’__main__’:
    part_sum(1, 10)
</pre>
<p>To compile this into an extension module, type:</p>
<pre class="literal-block">
shedskin -e meuk
make
</pre>
<p><strong>Parallel Python</strong></p>
<p>To use the generated extension module with <a class="reference external" href="http://www.parallelpython.com/">Parallel Python</a> &gt;= 1.5.1, simply add a pure-Python wrapper:</p>
<pre class="literal-block">
import pp

def part_sum(start, end):
    import meuk
    return meuk.part_sum(start, end)

job_server = pp.Server()
job_server.set_ncpus(2)

jobs = []
jobs.append(job_server.submit(part_sum, (1, 10000000)))
jobs.append(job_server.submit(part_sum, (10000001, 20000000)))

print sum([job() for job in jobs])
</pre>
<p><strong>pprocess</strong></p>
<p>To use the generated extension module with <a class="reference external" href="http://www.boddie.org.uk/python/pprocess.html">pprocess</a>, follow the same approach:</p>
<pre class="literal-block">
import pprocess

def part_sum(start, end):
   import meuk
   return meuk.part_sum(start, end)

results = pprocess.Map(limit=2)
part_sum = results.manage(pprocess.MakeParallel(part_sum))

part_sum(1, 10000000)
part_sum(10000001, 20000000)

print sum(results)
</pre>
</div>
<div class="section" id="id9">
<span id="calling-c-c-code"></span><h1><a class="toc-backref" href="#id21">Calling C/C++ Code</a></h1>
<p>To call manually written C/C++ code, follow these steps:</p>
<ol class="arabic">
<li><p class="first">Provide <strong>Shed Skin</strong> with enough information to perform type inference, by providing it with a <em>type model</em> of the C/C++ code. Suppose we wish to call a simple function that returns a list with the n smallest prime numbers larger than some number. The following type model, contained in a file called <tt class="docutils literal"><span class="pre">stuff.py</span></tt>, is sufficient for <strong>Shed Skin</strong> to perform type inference:</p>
<pre class="literal-block">
#stuff.py

def more_primes(n, nr=10):
    return [1]
</pre>
</li>
<li><p class="first">To actually perform type inference, create a test program, called <tt class="docutils literal"><span class="pre">test.py</span></tt>, that uses the type model, and compile it:</p>
<pre class="literal-block">
#test.py

import stuff
print stuff.more_primes(100)

shedskin test
</pre>
</li>
<li><p class="first">Besides <tt class="docutils literal"><span class="pre">test.py</span></tt>, this also compiles <tt class="docutils literal"><span class="pre">stuff.py</span></tt> to C++. Now you can fill in manual C/C++ code in <tt class="docutils literal"><span class="pre">stuff.cpp</span></tt>. But to avoid that it is overwritten the next time <tt class="docutils literal"><span class="pre">test.py</span></tt> is compiled, first move <tt class="docutils literal"><span class="pre">stuff.*</span></tt> to the <strong>Shed Skin</strong> <tt class="docutils literal"><span class="pre">lib/</span></tt> dir.</p>
</li>
</ol>
<p><strong>Standard Library</strong></p>
<p>By moving <tt class="docutils literal"><span class="pre">stuff.*</span></tt> to <tt class="docutils literal"><span class="pre">lib/</span></tt>, we have in fact added support for an arbitrary module to <strong>Shed Skin</strong>. Other programs compiled by <strong>Shed Skin</strong> can now import <tt class="docutils literal"><span class="pre">stuff</span></tt> and use <tt class="docutils literal"><span class="pre">more_primes</span></tt>. There is no difference with adding support for a <em>standard library</em> module. In fact, in the <tt class="docutils literal"><span class="pre">lib/</span></tt> directory, you can find type models and implementations for all supported modules (see <a class="reference internal" href="#library-limitations">Library Limitations</a>). As you may notice, some have been partially converted to C++ using <strong>Shed Skin</strong>.</p>
<p><strong>Shed Skin Types</strong></p>
<p><strong>Shed Skin</strong> reimplements the Python builtins with its own set of C++ classes (built on the C++ Standard Template Library). These have a similar interface to their Python counterparts, so they should be easy to use (provided you have some basic C++ knowledge.) See the class definitions in <tt class="docutils literal"><span class="pre">lib/builtin.hpp</span></tt> for details. If in doubt, convert some equivalent Python code to C++, and have a look at the result!</p>
</div>
<div class="section" id="id10">
<span id="command-line-options"></span><h1><a class="toc-backref" href="#id22">Command-line Options</a></h1>
<p>The <tt class="docutils literal"><span class="pre">shedskin</span></tt> command can be given the following options:</p>
<pre class="literal-block">
-a --noann             Don't output annotated source code
-b --nobounds          Disable bounds checking
-d --dir               Specify alternate directory for output files
-e --extmod            Generate extension module
-f --flags             Provide alternate Makefile flags
-r --random            Use fast random number generator
-w --nowrap            Disable wrap-around checking
</pre>
<p>For example, to compile the file <tt class="docutils literal"><span class="pre">test.py</span></tt> as an extension module, type <tt class="docutils literal"><span class="pre">shedskin</span> <span class="pre">–e</span> <span class="pre">test</span></tt> or <tt class="docutils literal"><span class="pre">shedskin</span> <span class="pre">––extmod</span> <span class="pre">test</span></tt>.</p>
<p>In Python, exceptions are raised for index out-of-bounds errors, as in the following example. Because checking for these errors can slow down certain programs, it can be turned off with the <tt class="docutils literal"><span class="pre">--nobounds</span></tt> option.</p>
<pre class="literal-block">
a = [1, 2, 3]
print a[5] # invalid index: out of bounds
</pre>
<p>Also, negative index values can often be used to count 'backwards' (<tt class="docutils literal"><span class="pre">a[-1]</span></tt> in the example). Because checking for this can also slow down certain programs, it can be turned off with the <tt class="docutils literal"><span class="pre">--nowrap</span></tt> option.</p>
</div>
<div class="section" id="id11">
<span id="tips-and-tricks"></span><h1><a class="toc-backref" href="#id23">Tips and Tricks</a></h1>
<p><strong>Performance</strong></p>
<ol class="arabic">
<li><p class="first">Allocating many small objects (e.g. by using <tt class="docutils literal"><span class="pre">zip</span></tt>) typically does not slow down Python programs by much. However, after compilation to C++, it can quickly become a bottleneck. The key to getting excellent performance is to allocate as few objects as possible.</p>
</li>
<li><p class="first"><strong>Shed Skin</strong> takes the flags it sends to the C++ compiler from the <tt class="docutils literal"><span class="pre">FLAGS</span></tt> file in the <strong>Shed Skin</strong> working directory. These flags can be modified or overruled by creating a local file with the same name, or by directly editing the generated Makefile. The following flags typically give good results:</p>
<pre class="literal-block">
-O3 -s -fomit-frame-pointer -msse2
</pre>
</li>
<li><p class="first">Profile-guided optimization can help to squeeze out even more performance. For a recent version of GCC, first compile and run the generated code with <tt class="docutils literal"><span class="pre">-fprofile-generate</span></tt>, then with <tt class="docutils literal"><span class="pre">fprofile-use</span></tt>.</p>
</li>
<li><p class="first">Several Python features (that may slow down generated code) are not always necessary, and can be turned off. See the section <a class="reference internal" href="#command-line-options">Command-line Options</a> for details.</p>
</li>
<li><p class="first">When optimizing, it is extremely useful to know exactly how much time is spent in each part of your program. The program <a class="reference external" href="http://code.google.com/p/jrfonseca/wiki/Gprof2Dot">Gprof2Dot</a> can be used to generate beautiful graphs for both the Python code and the compiled code.</p>
</li>
</ol>
<p><strong>Other tips</strong></p>
<ol class="arabic simple">
<li>When recompiling an extension module, <tt class="docutils literal"><span class="pre">make</span></tt> will fail if the <tt class="docutils literal"><span class="pre">.pyd</span></tt> or <tt class="docutils literal"><span class="pre">.so</span></tt> file can’t be overwritten. This problem may occur when using <strong>IPython</strong>: after importing a module, it is impossible to overwrite the <tt class="docutils literal"><span class="pre">.pyd</span></tt> or <tt class="docutils literal"><span class="pre">.so</span></tt> file as long as <strong>IPython</strong> is kept open.</li>
<li>If you modify a module after compiling it with <strong>Shed Skin</strong>, you may find yourself unable to import the new version (e.g. to test it in <strong>CPython</strong> before recompiling with <strong>Shed Skin</strong>) until you delete the corresponding <tt class="docutils literal"><span class="pre">.pyd</span></tt> or <tt class="docutils literal"><span class="pre">.so</span></tt> file.</li>
</ol>
<p><strong>Tricks</strong></p>
<ol class="arabic">
<li><p class="first">The following two code fragments work the same, but only the second one is supported:</p>
<pre class="literal-block">
statistics = {'nodes': 28, 'solutions': set()}

class statistics: pass
s = statistics(); s.nodes = 28; s.solutions = set()
</pre>
</li>
<li><p class="first">The evaluation order of arguments to a function or <tt class="docutils literal"><span class="pre">print</span></tt> changes with translation to C++, so it's better not to depend on it:</p>
<pre class="literal-block">
print 'hoei', raw_input() # raw_input is called before printing 'hoei'!
</pre>
</li>
<li><p class="first">Tuples with different types of elements and length &gt; 2 are not supported. It can however be useful to 'simulate' them:</p>
<pre class="literal-block">
a = (1, '1', 1.0) # bad
a = (1, ('1', 1.0)) # good
</pre>
</li>
</ol>
</div>
<div class="section" id="id12">
<span id="how-to-help-out-in-shed-skin-development"></span><h1><a class="toc-backref" href="#id24">How to help out in Shed Skin Development</a></h1>
<p>Open source projects, especially new ones such as <strong>Shed Skin</strong>, thrive on user feedback. Please send in bug reports, patches or other code, or suggestions about this document; or join the mailing list and start or participate in discussions (see the <a class="reference external" href="http://shedskin.googlecode.com/">Googlecode site</a>.)</p>
<p>If you are a student, you might want to consider applying for the yearly Google <a class="reference external" href="http://code.google.com/soc/">Summer of Code</a> or <a class="reference external" href="http://code.google.com/opensource/ghop/">GHOP</a> projects. <strong>Shed Skin</strong> has so far successfully participated in one Summer of Code and one GHOP.</p>
<p>I would like to thank the following company/people, for their help with <strong>Shed Skin</strong> so far:</p>
<ul class="simple">
<li>Google</li>
<li>Bearophile</li>
<li>Brian Blais</li>
<li>Paul Boddie</li>
<li>Djamel Cherif</li>
<li>Mark Dewing</li>
<li>James Coughlan</li>
<li>Michael Elkins</li>
<li>FFAO</li>
<li>Luis M. Gonzales</li>
<li>Karel Heyse</li>
<li>Denis de Leeuw Duarte</li>
<li>Van Lindberg</li>
<li>David Marek</li>
<li>Jeff Miller</li>
<li>Joaquin Abian Monux</li>
<li>Harri Pasanen</li>
<li>SirNotAppearingInThisTutorial</li>
<li>Dave Tweed</li>
<li>Jaroslaw Tworek</li>
<li>Pavel Vinogradov</li>
</ul>
</div>
<div class="section" id="shed-skin-roadmap">
<span id="roadmap"></span><h1><a class="toc-backref" href="#id25">Shed Skin Roadmap</a></h1>
<p>The following activities are planned for future versions of <strong>Shed Skin</strong>:</p>
<p><strong>0.3-0.9</strong> (6-24 months from now)</p>
<ul class="simple">
<li>Complete support for the <tt class="docutils literal"><span class="pre">os</span></tt> module under Windows</li>
<li>Upgrade MingW to something more recent</li>
<li>Replace many quick hacks in the compiler core</li>
<li>Improve I/O performance</li>
<li>Locate bugs using some Python regression test suite, and fix them.</li>
<li>Improve packaging of generated code</li>
<li>Add support for tuples with mixed elements up to a certain length</li>
<li>Improve the type inference techniques with at least <em>iterative deepening</em> and basic selector-based <em>filters</em>.</li>
<li>Compile at least one program of around 3,000 lines, for example <a class="reference external" href="http://quameon.sourceforge.net/">Quameon</a>.</li>
</ul>
<p><strong>1.0</strong> (24-48 months from now)</p>
<ul class="simple">
<li>Add support for multiple inheritance, generator expressions and nested functions</li>
<li>Improve type inference to the point where it works for typical, arbitrary programs of around 3,000 lines.</li>
</ul>
</div>
</div>
</body>
</html>
